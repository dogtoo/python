    var painterKline = function(canvasId, paintStream) {
        Painter.call(this, canvasId, paintStream);
    };
    painterKline.prototype = Object.create(Painter.prototype);
    painterKline.prototype.constructor = painterKline;
    painterKline.prototype.preData = function() {
        var kline = [];

        var fline = [];
        var tline = [];
        var sline = [];

        var priceL = [];
        var dateL = [];
        var price = {};
        var date = {};
        
        var volume = [0];
        var volKline = [];
        
        var yHistory = {};
        var hline = [];
        
        for (var i =ã€€0; i < this.data.length; i++) {
            var rawData = this.data[i];
            yHistory[Number(rawData['high'])] = 1;
            yHistory[Number(rawData['low'])] = 1;
            hline.push([rawData['quoteTime'], rawData['close']]);
            if (i >= cb.options.begin && i <= cb.options.end) {
                price[Number(rawData['high'])] = 1;
                price[Number(rawData['low'])] = 1;
                date[rawData['quoteTime']] = 1;
                kline.push([rawData['quoteTime']
                          , rawData['open']
                          , rawData['close']
                          , rawData['high']
                          , rawData['low'] ]);

                fline.push(MACount(5, i, this.data));
                tline.push(MACount(10, i, this.data));
                sline.push(MACount(20, i, this.data));
                
                volume.push(rawData['volume']);
                if (rawData['close'] > rawData['open'])
                    volKline.push([rawData['quoteTime'], 0, rawData['volume'], 0, rawData['volume'] ]);
                else
                    volKline.push([rawData['quoteTime'], rawData['volume'], 0,  rawData['volume'], 0]);
                    
            }
        }
        //console.log('kline.length = ' + kline.length + ', begin = ' + cb.options.begin + ', end = ' + cb.options.end);
        this.data.kline = kline;
        this.data.fline = fline;
        this.data.tline = tline;
        this.data.sline = sline;

        for (var pk in price)
            priceL.push(pk);

        priceL.sort(function(a, b) {
            return a - b;
        });
        this.data.price = priceL;
        //Object.keys(price).reduce((a, c) => (a[c] = price[c], a), {});

        for (var dk in date)
            dateL.push(dk);

        dateL.sort(function(a, b) {
            return a - b;
        });
        this.data.date = dateL;

        volume.sort(function(a, b) {
            return a - b;
        });
        this.data.volumeY = volume;
        
        this.data.volKline = volKline;
        
        var yHistoryL = [];
        for (var pk in yHistory)
            yHistoryL.push(pk);

        yHistoryL.sort(function(a, b) {
            return a - b;
        });
        this.data.yHistory = yHistoryL;
        this.data.hline = hline;
    }
    painterKline.prototype.start = function () {
        this.ctx.beginPath();
        this.ctx.strokeStyle = 'gray';
        this.ctx.save();
        this.ctx.translate(this.paintRegion['main.x']
                       , this.paintRegion['main.y']);

        this.ctx.rect(0, 0
                       , this.paintRegion['main.width']
                       , this.paintRegion['main.height']);
        this.ctx.stroke();
        var spaceHeight = 0;

        for (var i in this.implements.price.options.y) {
            this.drawHLine('#eeeeee', 0, this.implements.price.options.y[i], this.paintRegion['main.width'], 1, 'solid');
            this.ctx.stroke();
        }

        var v_c = Math.round((this.implements.date.options.x.length)/this.implements.date.options.verticalLineCount);
        for (var i = 0 ; i < this.implements.date.options.x.length ; i+= v_c) {
            var diff = this.implements.date.options.x.length - i;
            if (diff < v_c) v_c = diff;
            this.drawVLine('#eeeeee', this.implements.date.options.x[i], 0,this.paintRegion['main.height'], 1, 'solid');
            this.ctx.stroke();
        }
        this.drawVLine('#eeeeee', 0, 0,0, 1, 'solid');
        this.ctx.stroke();
        this.ctx.restore();
        
        this.ctx.save();
        this.ctx.translate(this.paintRegion['volmain.x']
                       , this.paintRegion['volmain.y']);
        
        this.ctx.rect(0, 0
                       , this.paintRegion['volmain.width']
                       , this.paintRegion['volmain.height']);
                       this.ctx.stroke();
        
        
        for (var i in this.implements.volumeY.options.y) {
            this.drawHLine('#eeeeee', 0, this.implements.volumeY.options.y[i], this.paintRegion['main.width'], 1, 'solid');
            this.ctx.stroke();
        }
        
        
        
        var v_c = Math.round((this.implements.date.options.x.length)/this.implements.date.options.verticalLineCount);
        for (var i = 0 ; i < this.implements.date.options.x.length ; i+= v_c) {
            var diff = this.implements.date.options.x.length - i;
            if (diff < v_c) v_c = diff;
            this.drawVLine('#eeeeee', this.implements.date.options.x[i], 0,this.paintRegion['volume.height'], 1, 'solid');
        }
            
        this.ctx.restore();
    }
    
    painterKline.prototype.load = function(control, data) {
        this.data = data.kline;
        this.control.options = control.options;
        this.control.options.length = data.kline.length;
        control.setNext.call(this.control);
        //console.log(this.control.options.begin + ', ' + this.control.options.end);
    };
    painterKline.prototype.make = function() {
        this.init();
        this.build();
        this.build(true);
    }

    function MACount(maType, date, data) {
        maType = maType - 1;
        var MA = 0;
        if (maType > 50)
            console.log(maType + "date:" + date);
        if (date > maType) {
            for (var ma = date-maType-1; ma <= date-1; ma++)
                MA = MA + data[ma]['close'];
            return [data[ma]['quoteTime'], (MA / (maType+1))];
        } else {
            return [null, null];
        }
    }
